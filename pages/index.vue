<template>
  <UContainer class="h-dvh flex flex-col items-center justify-center">
    <UCard class="md:size-[500px] m-4 size-full overflow-auto">
      <UForm @submit="onSubmit" :state :schema class="space-y-3">
        <UFormGroup label="Who is Joking" required name="name">
          <UInput v-model="state.name" placeholder="Enter Name Here" />
        </UFormGroup>
        <UFormGroup label="Joke" required name="joke">
          <UInput v-model="state.joke" placeholder="Enter Joke Here" />
        </UFormGroup>
        <UButton type="submit" :loading="listStatus === 'pending'">
          Submit
        </UButton>
      </UForm>

      <ul class="mt-5 space-y-3">
        <template v-for="joke in data">
          <li class="flex items-start justify-between">
            <p>{{ joke.name }} : {{ joke.joke }}</p>
            <UButton
              @click="openDialog(joke)"
              size="sm"
              icon="tabler:trash"
              color="red"
              variant="ghost"
            ></UButton>
          </li>
        </template>
      </ul>
    </UCard>
    <UModal v-model="showDialog">
      <UCard>
        <h3>
          You wanted to delete
          <b class="text-green-500">{{ activeJoke?.joke }}</b> that is said by
          <b class="text-green-500"> {{ activeJoke?.name }} </b> ? ðŸ˜‚
          <br />
          that ain't gonna happen Ø®ÙˆØ´Ú¯Ù„Ù‡
        </h3>
      </UCard>
    </UModal>
  </UContainer>
</template>

<script setup lang="ts">
import { object, string, type InferType } from "yup";
import type { FormSubmitEvent } from "#ui/types";
import type { IJokeItem } from "~/types/jokes.type";

const schema = object({
  name: string().required(),
  joke: string().required(),
});

type Schema = InferType<typeof schema>;

const state = reactive<Schema>({
  name: "",
  joke: "",
});

const activeJoke = ref<IJokeItem>();

const { data, refresh, status: listStatus } = await useFetch("/api/jokes");
const { execute, status } = await useFetch("/api/jokes", {
  method: "POST",
  immediate: false,
  watch: false,
  body: state,
});

const showDialog = ref(false);

async function onSubmit(event: FormSubmitEvent<Schema>) {
  await execute();
  if (status.value === "success") {
    refresh();
  }
}

function openDialog(joke?: IJokeItem) {
  activeJoke.value = joke;
  showDialog.value = true;
}
</script>
